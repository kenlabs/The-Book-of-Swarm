## 背景

* 蜂群网络的特点：蜂群网络是由许多独立节点构成的，这些节点运行的软件实现了蜂群协议。
* 蜂群网络的自治行为：由于节点是自治的，它们基本上可以“自由”地对其他对等节点的传入消息作出任何它们想做的反应。所以，即使节点运行相同的协议，网络的紧急行为不能由协议来单独保证。
* 蜂群网络的激励措施：无论如何，让节点以一种有利于网络期望的突发行为的方式作出反应是有利可图的，而以一种有害的方式作出反应则是昂贵的。广义地说，这是通过使价值从那些使用网络资源的节点(净用户)转移到那些提供它的节点(净提供者)来实现的。

* 



## 共享带宽

##### 鼓励服务和中继

Kademlia转发和多次交易

数据块的检索最终是由访问内容的人发起的，因此，与此检索相关的所有成本都应该由他们承担。

但是当今的网络是“免费的”，付费检索可能听起来不像是一个流行的想法。当前网络的许多问题源于消费者无法与内容发布者直接分担托管和分发的成本。

原则上，数据块的检索可以被视为一个功能单元，其中存储者充当服务提供者，请求者充当消费者。当服务由提供者提供给消费者时，消费者应向提供者提供补偿。

这样的直接交易通常要求交易方彼此都是已知的，所以如果我们要保持下载的匿名要求，我们必须以一种新颖的方式来概念化补偿。

在我们使用Forwarding Kademlia时，数据块检索包含了转发节点执行的一系列转发动作。因为这些都是独立的参与者，所以有必要对每个独立的接力行为进行激励。

重要的是，如果只有中继实例是重要的，那么，不管会计和补偿的细节(见3.2.1)，事务处理程序都被限制在连接的对等体上。

鉴于连接的对等点集是跨会话的准永久集，这允许我们在重复交易的上下文中构建交互。这样的设置总是会为当事各方创造额外的动机，让他们友好相处。选择历史记录清白的同行是合理的。此外，由于这个准永久集对网络规模是对数的，与对等体重复交互可能需要的任何簿记或区块链合约都是可管理的，提供了一个可伸缩的解决方案。反过来说，我们可以说，与可管理的对等节点数量保持平衡，以及请求发起的模糊性是节点具有有限连通性的原因，也就是说，它们选择更精简的Kademlia bins。

##### 反向响应付费

1，成功检索了才付费

2，检索不存在的数据块，要受到惩罚

3，如果检索节点请求了多个提供者，只要提供者响应成功，检索节点就必须付费


如果接受一个检索请求已经构成了转发节点的收入，即在响应交付之前触发了一个记入下游对等体的记账事件，那么它就产生了不转发请求的反常动机。将请求收入满足于成功检索是一种自然的解决方案:只有在将请求块交付给其请求者时才会触发会计事件，见图20。
但是，如果一个请求没有开销，那么就可以为不存在的块(随机地址)发送许多不合法的请求。通过对向不存在的块发送太多请求的对等体施加制裁，很容易减轻这种情况(见3.2.7)。
一旦一个节点发起(启动或转发)一个请求，如果该块在定义的生存时间(TTL)内被交付，它就提交为该块支付费用，因此，当该块被传递回来时，就不存在阻止及时交付的动机。这种承诺也阻止了节点轻率地向太多的对等体请求块，因为，如果多个对等体响应交付，每个节点都必须付费。

##### 数据块检索的定价协议
接下来，我们描述了在Swarm网络中，节点用于传递它们的块的价格的协议。在此协议的基础上，希望在服务质量和价格方面与其他节点竞争的节点可以实施策略(见9.3)。

* 价格发现：价格发现机制仅基于本地决策
  该协议的主要优点是，它允许价格发现机制仅基于本地决策，这是必要的，原因如下:(1)带宽成本在世界各地是不同的:允许节点通过其价格表达其成本结构将使价格和质量竞争，最终使终端用户受益。(2)由于使用率或连通性的波动，对带宽资源的需求是不断变化的。(3)能够直接对变化做出反应，就能创造一个自我调节的系统。

* 带宽是一种伴随“即时满足”而来的服务，因此立即确认和核算其成本是合理的。默认价格为零，对应免费服务（利他策略）。



实际上，如果没有这种可能性，节点运营商可能会在成本上升时决定关闭他们的节点，或者相反，当成本或需求下降时，终端用户可能会在一段时间内支付过多的费用，节点没有相应降低价格的竞争压力。
带宽是一种伴随“即时满足”而来的服务，因此立即确认和核算其成本是合理的。由于很难想象带宽的总体需求和供应中存在任何外部性或非线性，一种定价机制既提供了(1)高效和即时的信号传输，也提供了(2)具有最小切换和发现成本的竞争选择，最可能适应的策略，导致一个全局最优的资源分配。
为了实现这一点，我们引入了一个协议消息，它可以将这些价格传递给上游对等点(见8.4)。我们可以将此消息概念化为对请求的另一种响应。节点为每个邻近距离维护与每个对等体相关联的价格，因此当它们发出检索请求时，它们已经知道下游对等体在生存期内成功交付有效块时承诺支付的价格。然而，将价格信号仅仅局限于响应是没有意义的:无论出于何种原因，一个同行决定改变价格，即使有响应请求，交换这一信息也符合双方的利益。为了防止价格变化消息充斥上游对等体的DoS攻击，价格消息的速率被限制。表现良好、价格有竞争力的节点受到同行的青睐;如果一个节点的价格设定过高，或者其价格的波动性比网络中的其他节点高得多，那么其他节点就不太愿意向它们请求区块
为了简单的推理，我们假设默认价格为零，对应免费服务(利他策略，见9.3)。

差别定价：根据节点邻近程度进行差异化定价，奖励转发节点。



节点每服务一个数据块就会获得奖励，因此数据块的盈利能力与它的受欢迎程度成正比:数据块被请求的频率越高，相对于每个时间单位存储的固定成本，其奖励就越高。当节点达到存储容量限制，并决定删除哪些块时，理性利润最大化代理的最优策略是删除利润率最低的块。一个相当好的预测是最后请求的年龄。为了最大化可选择的块集，节点会有机会缓存它们所传递的数据以及它们同步的数据块。这将导致流行内容更广泛地传播和更快地服务，使整个群体成为一个自动扩展和自动平衡的内容分发网络。



统一定价

Bin 密度

缓存和自动扩展

无缓存节点

##### 激励推送同步

## SWAP：审计和结算

本节介绍与带宽共享相关的激励机制。

在3.2.1中，我们引入了一种机制来跟踪对等点之间的数据流量，并为消息中继提供对等计费。

随后，在3.2.2中，我们描述了补偿不平衡服务的条件，并展示了如何解决可以实现。我们特别介绍支票和支票本合同的概念。

在3.2.3中，我们讨论了豁免，进一步优化允许更多的交易成本节省。

在3.2.5中，我们讨论了发送现金交易的激励服务如何使零现金进入Swarm，

最后，在3.2.7中，我们将讨论基本的制裁，作为一个基本的激励，让节点更好地玩和遵守协议。

#### 对等节点会计

[Tron et al.， 2016]引入了一种p2p会计协议，称为交换。交换是一种针锋相对的会计方案(见8.7)，并可以扩展微交易。该方案允许直接连接的对等节点交换支付或支付承诺。系统的主要功能是通过不同的缩略词SWAP的助记分辨率来捕捉的:

服务需要和提供的群集计费协议-服务交换的帐户服务。
•使用自动付款结算-超过付款门槛时发送支票。
•将放弃作为付款-债务可以在未兑现的支票价值中被放弃。
•开始没有一分钱和发送与对等-零现金入口支持单向交换。



#### 保险：反向激励

到目前为止，存储奖励指的是系统通过给予存储者金钱奖励来鼓励内容保存的能力。这是通过邮资抽奖实现的，它有助于将邮资支付公平地重新分配给商店。通过这个方案，我们在集体层面上提供了积极的激励。然而，这样的系统被怀疑是公地悲剧问题，因为消失的内容不会对任何一个存储节点产生负面影响。个人责任的缺乏使得存储激励作为防止数据丢失的安全措施受到限制。另一方面，引入竞争性保险，增加了一层额外的负面激励，并迫使存储人员非常精确地履行为用户提供可靠性的承诺。在激励机制的设计上需要特别注意，以确保如果未能存储承诺的每一个比特，不仅不会盈利，而且对保险公司来说是灾难性的。

#### 惩罚措施
与立即计算和结算检索的带宽激励情况不同，长期存储保证在本质上是承诺的，它只能决定是否在其有效性结束时履行了承诺。在这些情况下，名誉的损失不足以阻止不正当行为:由于必须允许新节点立即提供服务，作弊者只能依靠新的身份，继续出售(空的)存储承诺。
我们需要惩罚性措施的威胁，以确保遵守储存承诺。这些将使用存款系统。希望出售承诺存储收据的节点应该在作出承诺时验证并锁定其股份。这意味着节点必须预先以合同注册，并缴纳保证金。注册之后，一个节点可以出售覆盖其资金被锁定期间的存储承诺。虽然他们的注册是活跃的，但如果他们被发现失去了他们的承诺所覆盖的一部分，他们就会失去他们的存款。

需求
让我们从一些合理的指导原则开始:
•所有者在提交存储时需要表达其风险偏好。
•存储人员在进行存储时需要表达他们的风险偏好。
•要建立合理的供求匹配市场机制。
•需要为所有者保证其内容是安全存储的。
•需要建立一套诉讼制度，让商店因不遵守承诺而被收费。
业主的风险偏好包括所涵盖的时间期限和对可靠性程度的偏好。这些首选项应该在每个块的基础上指定，并且它们应该在协议级别上完全灵活。
满足商店的风险偏好意味着他们有办法表达他们对保留他们所存储的东西的确定性，并在定价时考虑到这一点。一些节点可能不希望提供太长时间的存储保证，而另一些节点无法承担太多的存款。这使得节点在服务提供的竞争中有所不同。
市场机制意味着存在灵活的价格谈判、发现或自动反馈循环，这些循环往往会对供求变化作出反应。
以下我们将详细介绍一类激励方案，由于其基本组成部分，我们将其称为互换、宣誓和欺诈:
交换节点与它们注册的对等节点处于准永久的长期接触中。在这些连接中，对等点交换块和收据触发交换记帐(见3.2.1)。
在链上诉讼过程中，如果被发现违反了Swarm规则，在Swarm网络上注册的节点将承担责任，并将失去他们的存款。
诈骗节点监控其他节点，以检查他们是否遵守他们的承诺提交挑战根据诉讼程序。



#### 通过收据执行智能合约
诉讼过程需要双方签订合约协议将以下两者联系在一起：

* 为确保未来内容可用而付费的所有者
* 保存内容并使其在未来随时可访问而获得奖励的存储者

激励机制需要确保诉讼是最后的选择。

管理存储交易的最简单的解决方案是数据所有者和数据存储者之间的直接合约。实现方式如下：

* 保险存储者返回他们接受存储的数据块的签名收据
* 所有者直接或通过托管向收据支付资金

只有当存储者能够提供存储证明时，他们才能获得锁定的资金。这个过程类似于邮票彩票。保险可以以特别标记的邮票的形式购买，保管收据的声明可以关闭循环，并代表上传者和存储者之间的合约。以托管证明为条件的支付可以像彩票一样实现。

存储提供者不能交付存储的内容将受到惩罚。甚至是没有直接和存储提供者达成存储协议的用户，只要试图访问数据块但无法访问时，存储者都将受到惩罚。因此，期望检索内容的第三方可以发起诉讼。

如果数据块和收据的配对是公开的和可访问的，那么在发现数据块丢失的情况下，内容的消费者/下载者（不仅仅是创建者/上传者）都可以发起诉讼（见5.3）。

#### 节点注册

在节点出售长期存储的承诺之前，它必须向区块链上的一个合约进行注册，我们称之为SWEAR合约 （Secure Ways of Enforcement And Registration，确保归档或者强制执行和注册的安全方法）。SWEAR合约允许节点注册它们的公钥，从而成为蜂群中负责任的参与者。注册是通过将押金发送到承诺合约来完成的，如果已注册节点违反其“承诺”遵守的条款（即节点不遵守其存储承诺），该合约将作为担保。注册状态有一个有效期限，期限结束，Swarm节点有权拿回它们的抵押存款。注册状态被接受之后，Swarm的用户可以依靠抵押存款的罚没作为对违规行为的抑制。因此，在注册状态期限结束之前，押金不能取回。因此，期限结束还应该包括一个最后期限，在此期间节点不允许发布新收据，但仍可以受到挑战。

当一个已注册的保险节点收到存储（距离其最近）数据块的请求时，它可以用一个签名收据来确认该请求。正是这些签名收据被用来对内容丢失实施惩罚。由于被锁定的抵押支持，收据可以被视为存储和服务特定区块的安全承诺。



#### 提交一个挑战
如果一个节点未能遵守它们承诺遵守的Swarm规则，那么就需要对该节点进行惩罚。在此惩罚之前，必须进行诉讼过程。这一过程的实施被称为SWINDLE (Secured With INsurance Deposit Litigation and Escrow，由保险存款抵押诉讼和托管担保）。

当用户试图检索投保的数据内容时，但未能找到一个数据块，用户可以通过提交挑战来报告数据丢失。这种情况是发起诉讼的典型情况。这类似于一个法庭案件，收据的发行方（存储提供方）在被证明无罪之前，是有罪的被告。与法院程序类似，当节点违背规则时，公益诉讼应该是最后的手段（尽管已经有了反面的威慑和正面的激励）。

挑战采用采用交易的方式，发送给SWINDLE合约。挑战者需要提供的是丢失数据块的收据。任何节点都可以向一个数据块发起一个挑战，只要节点拥有一个有效的收据（尽管可能不是直接发行给该节点的）。同一笔挑战交易还会发送一笔挑战押金，用于支付上传数据块的价格。质疑的有效性和反驳的有效性都需要容易被合约验证。合约通过检查以下条件来验证收据是否有效：

* 真实性（authentic）：收据是用注册节点的公钥签名的。
* 有效的（active）：收据没有过期。
* 诉讼质押资金（funded）：足够的资金将与收据一起发送，以补偿对等节点通过上传数据块来反驳该挑战。

第三点的设计是为了防止无聊的诉讼，即用虚假的挑战轰炸区块链，并可能导致DoS攻击。

合约附带了一个访问器，用于检查给定节点是否受到挑战（并可能会受到惩罚），因此可以通知受挑战的节点，它们必须及时提供数据块存储证明。然后，挑战会持续一段固定的时间，时间窗口结束基本上就是反驳挑战的最后期限。



#### 指纹识别或存储证明
诉讼涉及节点可以通过向区块链发送一个交易来反驳这个挑战，这个交易可以是直接的反驳（一个托管证明或数据块本身，这取决于数据块的大小），也可以是另一个节点签署的同一数据块的收据。这个收据需要由一个更近的邻居（一个比节点本身更接近数据块地址的注册对等节点）发出。换句话说，如果一个节点被一个收据挑战，节点可以转移挑战，并从更近的邻居提供有效的收据（合约可以很容易地验证新挑战的节点，是否比原来的被挑战节点更接近数据块地址，新挑战的节点签名收据作为反驳）。因此，诉讼可以触发一连串的挑战，从最初受到挑战的节点一直指向不能进一步推卸责任的节点，因此必须呈现数据块，否则将受到惩罚。这种反驳挑战的方式被称为指纹识别。

在验证反驳的格式后，合约检查反驳的有效性。检查方式是：

* 对比被举报的哈希和数据块有效负载的哈希
* 验证托管证明

如果一项挑战在关闭之前被驳回，则被挑战节点的存款抵押保持不变。上传数据块的开销必须从挑战的存款中补偿给上传者。但为了防止DoS攻击，在任何情况下，这个挑战存款实际上应该比这个高很多（例如，一个相应的Gas价格的很小整数倍）。挑战被成功反驳后，将从区块链状态中清除挑战。

这种挑战方案是：

* (1)被挑战者反驳挑战的最简单方法

* (2)使需要数据的节点能够获得实际数据的最简单方法



#### 挑战成功和强制执行

对挑战在一定的时间内没有申诉成功的，视为诉讼成立，案件进入执行阶段。被证明丢失数据块的节点将失去它们的存款。强制执行基于这样的事实：锁定在SWEAR合约中的存款抵押。

如果在一个举报诉讼中，存储提供方确实丢失了一个数据块（举报人持有收据来证明），存款押金必须燃烧掉一部分。请注意，这是必要的，因为如果将罚款支付给的收据持有者（举报者），这将通过串通用户，“丢失”用户存入的伪造数据块，为注册节点提供一个提前退出的途径。

由于Swarm的用户感兴趣的是他们的信息被可靠地存储。因此用户保存收据的主要动机是希望Swarm去存储数据，而不是希望Swarm不存储数据而获得潜在补偿。如果存款押金数额很大，我们可以为发起举报支付赔偿，但必须烧掉大部分存款押金（比如95%)，以确保关闭这条简单的退出途径。

惩罚使节点进入终止状态，这意味着有过失的节点不再被认为是已注册的Swarm节点。这样的节点只有在创建新身份并再次存入存款抵押后才能恢复售卖存储收据。注意，存储的数据块位于地址附近，因此必须创建一个新的标识，这也意味着需要花费额外的带宽来补充存储。这是对违规节点施加的额外惩罚。



#### 存款抵押
另一个需要做出的重要决定是，单个数据块的最高存款抵押是否应独立于存储价格。首先，很难对这意味着什么进行概念化。

假设一个节点的存款抵押影响到它们被选为存储节点的概率：存储价格相同时，存款抵押高的节点成为存储节点的概率更高。在这种情况下，节点有动机提高抵押，并开启竞标之战。在常规运维的情况下，这种竞标无法衡量服务质量的置信区间，而只是反映潜在存储提供方的财富。

我们得出的结论是，存储价格应该是可变的，并且完全取决于节点自己，但更高的置信或确定性应该直接反映在存款抵押数额上：每个数据块所持有的存款抵押应该是存储价格的常数倍。

假设s是一个系统级的安全常数，这个常数决定价格和存款抵押（损失）之间的比率，p是节点宣告的价格，那么，最低存款抵押是d = s·p。每一个数据块在每一个epoch的价格都是自由是可配置的，并且服从自由市场的供应和需求。因此，节点可以自由地遵循任何价格oracle或形成价格一致的卡特尔。



#### 鼓励服务履约
延迟付款而不锁定资金，使得卖家受到欺骗。相反，预付款（即在签订合同时就结算款项，而不是在储存期结束后）会让买家容易受到欺骗。

在不限制节点可以出售总额的情况下，恶意节点可以收集比它们的抵押存款更多的资金，然后消失。虽然节点违背承诺并损失一部分押金，但仍然并带走了一笔利润。

在网络规模给定的情况下，对存储保证的需求相对稳定，可以将抵押设置得足够高，可以使得这种攻击不再具有经济理性。

锁定全部资金可消除潜在的资不抵债而引起的存储提供方的不信任。在支付保险时，资金应该包含一块数据在整个存储期间的总价格。该金额被锁定，并在节点提供托管证明的条件下分批释放。另一方面，由于付款被延迟，在工作完成之前就不可能再收集资金，这就完全消除了“收集并运行”攻击。





## 总结

本书的前两个章节主要介绍Swarm的架构设计，这是蜂群系统实现的核心。第二章介绍对等网络层实现了基于chunk的分布式不可变存储，第三章介绍激励系统以补充第二章。综上，蜂群系统的基础层提供：
1. 无许可的参与和访问
2. 节点运营者零现金进入
3. 最大化资源利用率
4. 数据的负载均衡分布
5. 可伸缩性
6. 抗审查、存储和检索的隐私化
7. 热门数据的自动扩展

8. basic plausible deniability and confidentiality
9. 动态网络（节点可能随时退出）的抗抖动和最终的一致性
10. 无需干预的可持续性（由于内在的经济激励）
11. 鲁棒私密对等节点审计
12. 激励带宽共享
13. 链下微承诺，链上结算
14. 抗DoS攻击和消息滥发保护，
15. 正向激励（奖励）储存
16. 反向惩罚（即通过威胁惩罚措施来劝阻）数据丢失