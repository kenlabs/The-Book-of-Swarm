# 第二章 网络

本章讲述了Swarm是如何在对等网络协议之上构建覆盖网络的。这个覆盖网络形成一个拓扑结构，从而使得节点之间可以相互路由消息（第2.1节）。在第2.2章中，我们描述Swarm这样一个网络是如何成为数据块的可伸缩分布式存储解决方案（第2.2.1节），并给出了Swarm支持检索（下载）和同步（上传）协议的逻辑（2.3）。

## 2.1 拓扑和路由

本节通过明确底层网络（underlay network，第1层）的假设，从而为Swarm的覆盖网络（overlay network ，第2层）建立使用场景（第2.1.1节）。第2.1.2节介绍了覆盖网络的地址空间，并解释了如何为Swarm节点分配这些地址。在第2.1.3节中，我们展示了Kademlia覆盖拓扑（连接模式），并解释了Kademlia如何解决节点之间的路由问题。在2.1.4中，我们展示了如何运行Swarm客户端节点，以及客户端节点如何启动、如何相互发现，从而维护覆盖网络的拓扑结构。

#### 2.1.1 对底层网络的需求

Swarm是一个由用户直接操作的网络。网络中的每个节点都应该运行一个符合协议规范的客户端。在最低层网络中，网络中的节点连接使用对等网络协议作为传输层。这就是所谓的底层网络（underlay network）。在总体设计中，只要底层网络满足以下要求，特定的传输实现对Swarm来说是不可知的。
1. 寻址——节点由其底层地址标识。
2. 拨号——节点可以通过拨号底层地址发起到对等节点的直接连接。
3. 侦听——节点可以侦听其他节点的拨号，并可以接受传入的连接。不接受传入连接的节点称为轻节点。
4. 实时连接——节点之间的连接建立了一个通信通道，该通道在显式断开连接之前一直保持活跃，因此连接的存在意味着远端对等节点一直在线并可以接受消息。
5. 通道安全——通道提供身份验证，实现加密和认证传输，抵御中间人攻击。
6. 协议多路复用——底层网络服务可支持在同一连接上运行多个协议。对等节点用它们自己实现的名称和版本来建立协议，底层网络服务对兼容的协议进行标识，并在每个匹配的协议上启动对等节点之间的连接。
7. 交付保证——协议对消息有交付保证，即由于网络问题导致的交付失败将立即返回失败。另外，每个协议内部都保证了消息传递的顺序。理想情况下，底层协议提供了消息传递的优先级。如果在同一个传输通道上实现协议多路复用，这很可能意味着消息会被分帧，这样长消息就不会阻塞优先级更高的消息。
8. 序列化——协议中的消息构造支持任意的数据结构序列化约定。

libp2p库可以提供上述所有需要的功能，并且在Swarm规范中作为底层网络的连接驱动器给出，参见第8.1.1节。

注：Swarm目前的golang实现使用以太坊的Devp2p/rlpx，可以满足上述需求，并使用TCP/IP与自定义加密增加了安全功能。Devp2p底层网络地址使用enode URL方案。Devp2p基于协议的消息ID来分发消息。它使用RLP序列化，这种序列化使用更高级别的数据类型表示约定进行了扩展。为了支持以太坊1.0及其状态，我们可以提供一个瘦的devp2p节点作为代理，将查询转发给基于libp2p的Swarm客户端，或者仅仅使用libp2p客户端的API。不过，我们预计对devp2p网络的支持即将停止。

#### 2.1.2 覆盖网络寻址

当客户端使用底层地址与对等节点建立连接时，每个运行Swarm的节点都被附加一个覆盖地址标识。正是这个地址决定了一个节点将连接到哪个对等节点，并决定了消息转发的方式。覆盖地址被认为是稳定的，因为它定义了跨会话的节点标识，并最终影响哪些内容最值得存储在节点的本地存储中。

通过使用256位Keccak算法（见第7.2节）将相应的椭圆曲线公钥与bzz网络ID散列，节点的覆盖地址是从以太坊账户派生出来。包含BZZ网络ID的原因是可能存在许多Swarm网络（例如测试网、主网或私有Swarm网络）。如果包含BZZ网络ID，就不可能跨网络使用相同的地址。假设任何独立选择的基本帐户样本，所得到的覆盖地址都将在256位整数的地址空间中具有均匀分布。这对于从公钥中获取地址很重要，因为它允许节点使用可由第三方验证的加密签名发布与覆盖位置相关的承诺。

群节点利用底层网络的长寿命通信通道，形成一个准永久对等连接的网络。由此产生的连通性图可以实现在地址空间上定义的特定拓扑。选择的覆盖拓扑称为Kademlia：它通过提供一种只使用底层对等连接中继消息的策略，使Swarm网络中任意两个节点之间的通信成为可能。第8.3节中描述了一个名为“Hive”的协议，该协议描述了节点之间如何共享关于自己和其他节点的信息。节点如何使用该协议来引导覆盖拓扑将在2.1.4中讨论。Kademlia拓扑学的理论基础在文章《》中被严格形式化。

最重要的是，覆盖地址空间都是256位整数。蜂群的中心是接近顺序（proximity order,PO）的概念，它量化了两个地址在离散尺度上的相关性给定两个地址x和y, PO(x, y)对其二进制表示中的匹配位进行计数，从最高有效位开始，直到第一个不同的位为止。因此，最高的接近顺序为256，表示最大的亲缘关系，即x = y。

#### 2.1.3 Kademlia 路由

Kademlia拓扑可用于使用覆盖寻址在网络节点之间路由消息。它具有优秀的可伸缩性，因为它允许通用路由，这样(1)跳数和(2)对等连接的数量总是对网络规模的对数。
接下来，我们将介绍两种常见的路由:迭代/缩放和递归/转发。Swarm的设计关键在于选择后者，即转发风格。然而，这是不寻常的，而且，由于迭代风格在许多对等文献中占主导地位，而大多数其他实现都使用迭代路由(参见[Maymounkov和Mazieres, 2002, Baumgart和Mies, 2007, Lua等人，2005])，我们认为对读者介绍这两种方法是有用的，这样可以揭示它们的特点。

迭代和转发Kademlia
设R是网络节点上任意的二进制关系。与R相对的节点x称为x的对等体。x的对等体可以通过它们相对于x的接近顺序(PO)进行索引(见a .1)。对等体的等价类称为接近顺序箱，或简称箱。一旦被安排在箱子中，这些同伴组就形成了节点x的Kademlia表(见图2)。

#### 2.1.4 节点启动与Kademlia拓扑的维护

图2:从覆盖地址空间到Kademlia表。顶部:覆盖的地址空间用二叉树表示，有颜色的叶子是实际的节点。枢轴节点(+)的路径用粗线表示。中心:枢轴节点的对等点以距枢轴的异或距离的位为键值显示。这里0表示与主元匹配的位，1表示不同的位。叶节点按它们与枢轴(最左边的节点)的异或距离排序。底部:枢轴的Kademlia表:从枢轴路径分支出来的子树在左边显示为表的行，表示接近顺序箱，按递增顺序排列。



## 2.2 Swarm 存储

#### 基于数据块的分布式不可变存储



#### 内容寻址数据块



#### 单个所有者数据块



#### 数据块加密



#### 通过复制实现冗余





## 推和拉：数据块的检索和同步

#### 检索



#### 拉同步



#### 推同步



#### 轻节点



